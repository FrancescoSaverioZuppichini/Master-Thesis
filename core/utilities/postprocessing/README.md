# Post Processing

### Usage

#### Command line
To use the command line, run

```
python3 main.py --help
```

Example

Assuming you have this directory structure

```
├── test
│   ├── bags

```
Calling 
```
python3 main.py -i ./test/ -m ../../maps/test
```
Will result in

```
├── test
│   ├── bags
│   │   └── flat
│   ├── csvs
│   │   └── flat
│   └── outs
│       ├── df
│       └── patches
```
In which `./csvs` is the folder with all the complete csvs generated by the pipeline
and `./outs` is the folder with all the data we need to run the model, `/outs/df` contains all the meta dataframe
with columns `advancement` and `image_path` and `/outs/patches` contains all the generated patches from the data

#### Python

To use in your code you will need to import the handlers, `BagsHandler, DataFrameHandler, PatchesHandler`,
 as well as `PostProcessingConfig`, in your file. 
All these classes inherit from `Handler` and implements the single chain of responsability pattern. It follows a basic example

```python
import glob
from postprocessing import *

config = PostProcessingConfig(base_dir='/foo/data',
                                   maps_folder='/foo/maps',
                                   patch_size=92,
                                   advancement_th=0.12,
                                   skip_every=12,
                                   time_window=125,
                                   name='patches')

patches_h = PatchesHandler(config=config)
df_h = DataFrameHandler(successor=patches_h, config=config)
b_h = BagsHandler(config=config, successor=df_h)
# the bags handler needs a list of bags file path 
bags = glob.glob('{}/**/*.bag'.format(config.bags_dir))

list(b_h(bags))
```


We used [pypeln](https://github.com/cgarciae/pypeln) a 
*python library for creating concurrent data pipelines* to create the pipeline. 

The pipeline does the follow

- opens all the `bags` files and convert them to `pandas` `Dataframe` and set the index on the timestamp
- decorates the dataframes by:
    - converting the timestamp to the time relative for the simulation (e.g. first column timestamp -> 0.0s, last column = 20.0)
    - converting the pose's orientation quaternion to euler 
    - calculate the advancement
    - clear the data
- creates a meta dataframe with the `advancement` and the extracted `patch`

TODO
- [x] command line
