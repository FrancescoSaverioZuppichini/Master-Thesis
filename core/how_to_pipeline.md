# Running the pipeline

Currently the pipeline implementation is divided in two blocks:

1. Simulation. This block comprises webots simulator, custom controllers, and generated world files. This block runs on the host,
2. Containerised processes. This block comprises simulation manager (based on ROS+python3), Post-processing task, ML task, Visualisation task and Interpretability task. This block runs inside docker containers.

> It is possible that in future versions the 2nd block of the pipeline will be split so that ML, Visualisation, and Interpretability tasks run separately. 

For block 2 we employ three docker containers, one runs ROS, another runs a ROS topic throttling instruction and the third runs the development environment used to execute the pipeline


## Needed tools

### Install docker & peform post processing setup

> https://docs.docker.com/install/linux/docker-ce/ubuntu/
> https://docs.docker.com/install/linux/linux-postinstall/

### Install docker-compose

> https://docs.docker.com/compose/install/

### Install webots (tested with version 2019b)

> https://www.cyberbotics.com/#download


## About paths

As webots runs outside of the containers, for the moment we are using a shared folder to communicate with the development environment and share custom maps generated by it.

## Setup

### Build docker container

Before running the pipeline, we should build the docker image used to run the pipeline containers.

Open a terminal: go to the `core/`. Run `docker-compose -f docker-compose-pipeline.yml build trav-pipeline`

> This is a one time instruction. If a change in the image is done later on, the image should be rebuilt.

### Change paths

Change the shared path in the `docker-compose-pipeline.yml` file to a path of your choice (relative to your host's filesystem). This shared folder is used by the development container to place generated data.

### Instructions

Clone the repository and checkout the branch epfl_dev.

Copy the content of folder `core/simulation/env/webots/krock/krock2_ros/worlds/controllers` to the shared folder which in turn should be outside the scope of the repository folder. This will be considered the `webots_base_dir` and is used when running webots outside the containerised tasks.

Open a three terminals in `core/`.

Bring up the ROS core container:

> `docker-compose -f docker-compose-pipeline.yml up trav-pipeline-roscore`

Bring up the topic throttling container:

> `docker-compose -f docker-compose-pipeline.yml up trav-pipeline-throttle`

Open webots and open the file `krock2_camera.wbt`. A message should appear indicating that the controller has started and that a communication with ROS is active.

Run the container with the development environment:

> `docker-compose -f docker-compose-pipeline.yml run trav-pipeline bash`

Inside this container's bash, run `jupyter notebook`: 

> `jupyter notebook --no-browser --allow-root --ip 0.0.0.0 --port 9001`

Open a web browser in `http://localhost:9001`. Take the requested token from `jupyter`'s log.

Open the Simulation notebook from the `jupyter notebook` browser. 

Test the notebook (`ctrl-enter` in each cell) to reproduce the results from the pipeline. Remember to change the values of the path variables to your chosen paths:

>`out_dir='/home/omar/shared_data'`
>`webots_base_dir='/home/omar/shared_data/worlds/controllers'`


> Note: `webots+krock` section also needs tuning regarding path variables.

### Stopping

Press `ctrl-c` to stop the ROS core and throttling containers. To exit the development container use `exit` command.

After exiting all containers bring them down, this will perform a cleaning check and release used resources. From a terminal in `core/`:

> `docker-compose -f docker-compose-pipeline.yml down`

## Known-issues

> Depending on your network configuration, an error may appear when loading world files in webots. If that is the case you should open the file `core/simulation/env/webots/krock/krock2_camera.wbt` in webots and change the controller options (select the supervisor node from left pane and browse to the controller options), specifically `--ROS_MASTER_URI` to the ip of your ROS core container (e.g. `--ROS_MASTER_URI=http://127.0.0.1:11311`). You should do the same for the `krock2_camera.wbt` file copied to your shared folder.

> Before executing the pipeline, make sure that webots is running the opened world file  `krock2_camera.wbt` properly, i.e. a message appears indicating that the controllers was found and is connected to ROS.

> Webots does not find the controller. It seems to be a bug from webots. The world file (`.wbt`) needs to be in the same folder as the controller folder and both need to be placed inside a folder called `controllers`. This should not be normal given that webots documentation states that the world file should be in the parent project folder and (only) its controllers in a `controllers` folder. 

> We provide the `RosRobotControllerSim` controller as a binary. If an issue related to the controller arises when opening the world file, you might need to rebuild the controller. 
